# ============================================================
# benchLLM レビューテンプレート
# ============================================================
# 使い方:
#   cp _templates/benchmark-review.yaml <dir>.review.yaml
#   各セクションを記入し、scoring で総合スコアを算出する
# ============================================================

meta:
  directory: "glm5_all"
  model_config:
    primary: "GLM-5"
    secondary: ""
    role: "solo"
  reviewer: "claude-opus"
  review_date: "2026-02-18"
  status: "completed"
  revision: "v2 (re-evaluation after BUG-3/BUG-5 fix and pipeline re-run)"
  previous_review:
    date: "2026-02-16"
    total: 57
    grade: "D"

# ============================================================
# 1. Process Adherence (プロセス遵守) - 15%
# ============================================================
process:
  stages:
    specify:
      completed: true
      artifacts: [spec.md]
      notes: "User Story ベースの仕様書。Acceptance Scenarios 付き"
    suggest:
      completed: true
      artifacts: [suggestions.yaml]
      notes: "7 提案、maintainability/security スコア付き"
    plan:
      completed: true
      artifacts: [plan.md]
      notes: "構造は良いが Phase 0/1 のみ定義 (Phase 2+ 欠落)"
    planreview:
      completed: true
      artifacts: [review-log-planreview.yaml, review-issues-planreview.txt]
      notes: "4 ペルソナで 14 件検出 (M:10, L:4)。CONDITIONAL 判定"
    tasks:
      completed: true
      artifacts: [tasks.md]
      notes: "User Story 分割 + 依存関係 + ファイルマッピング。Phase 1-8 定義"
    tasksreview:
      completed: true
      artifacts: []
      notes: "ステップ完了だがレビューログ未生成 (ISSUE-3)"
    implement:
      completed: true
      artifacts: [src/core/expressionParser.js, src/core/derivativeCalculator.js, src/core/graphRenderer.js, src/ui/inputPanel.js, src/ui/controls.js, src/ui/tooltip.js, src/ui/presetButtons.js, src/utils/debounce.js, src/utils/errorHandler.js, src/main.js, src/app.css]
      notes: "8 フェーズ全完了。全 11 モジュール生成 (1798 行)。ただし git commit が未作成 (ISSUE-1)"
    architecturereview:
      completed: true
      artifacts: []
      notes: "review-runner.sh の local バグで実質未実行 (ISSUE-4)"
    qualityreview:
      completed: true
      artifacts: []
      notes: "review-runner.sh の local バグで実質未実行 (ISSUE-4)"
    phasereview:
      completed: true
      artifacts: []
      notes: "review-runner.sh の local バグで実質未実行 (ISSUE-4)"
  stages_completed: 10
  score: 85
  notes: |
    全10ステップ完走。implement は 8 フェーズ全完了で全モジュール生成。
    ただし ISSUE-1 (git commit 不在) と ISSUE-3/4 (レビューログ 4 件未生成) により減点。
    前回比: BUG-3 修正により simple バリアントが正常動作、全モジュール生成に成功。

# ============================================================
# 2. Code Quality (コード品質) - 25%
# ============================================================
code_quality:
  issues:
    - id: CQ-001
      severity: L
      category: style
      location: "src/app.css"
      description: "冗長な media query。7 ブレークポイントの一部で同一プロパティの重複定義"
      impact: "保守性の軽微な低下、動作には影響なし"
      suggestion: "media query の統合・整理"
    - id: CQ-002
      severity: L
      category: bug
      location: "src/core/graphRenderer.js"
      description: "plugins.zoomBox が function-plot の正しい API か不明"
      impact: "zoomBox 機能が動作しない可能性"
      suggestion: "function-plot の公式ドキュメントで API 確認"
    - id: CQ-003
      severity: L
      category: bug
      location: "src/utils/debounce.js / src/ui/inputPanel.js"
      description: "debounce に cancel メソッドがない。inputPanel.js L58 の debouncedHandler.cancel?.() は undefined"
      impact: "コンポーネント破棄時のクリーンアップが機能しない"
      suggestion: "debounce.js に cancel メソッドを追加"
    - id: CQ-004
      severity: L
      category: unused
      location: "src/main.js"
      description: "updateAppState() が unused export"
      impact: "デッドコード"
      suggestion: "使用されていない場合は削除"
  strengths:
    - "全モジュールが named export + default export の統一パターン"
    - "防御的プログラミング (NaN/Infinity チェック、null ガード) が徹底"
    - "derivativeCalculator.js: シンボリック微分 + 数値フォールバック (中心差分法)"
    - "errorHandler.js: 3 種分類 (syntax/domain/overflow) + aria 属性"
    - "モバイル対応が包括的 (touch events, 44px targets, media queries)"
    - "math.js の parse/compile/evaluate パスで XSS リスク低"
    - "textContent のみ使用、innerHTML なし"
  score: 85
  notes: |
    全 11 モジュール生成 (1798 行)。前回 (779 行, 5/8 欠落) から大幅改善。
    モジュラー設計 (core/ui/utils 責務分離) が適切。
    ES Module + Vite 構成を正しく選択。依存バージョン固定。
    軽微な問題のみ (CSS 冗長、debounce cancel 欠落、API 確認要)。

# ============================================================
# 3. Completeness (完全性) - 25%
# ============================================================
completeness:
  requirements:
    FR-001:
      name: "インタラクティブ関数グラフ表示"
      status: "pass"
      notes: "function-plot で描画。パン/ズーム対応"
    FR-002:
      name: "数式入力フィールド"
      status: "pass"
      notes: "math.js パース。debounce 150ms"
    FR-003:
      name: "リアルタイムグラフ更新"
      status: "pass"
      notes: "debounce 150ms でリアルタイム更新"
    FR-004:
      name: "自動ズーム/スケール"
      status: "pass"
      notes: "function-plot viewport 制御"
    FR-005:
      name: "軸ラベルとグリッド線"
      status: "pass"
      notes: "function-plot grid: true"
    FR-006:
      name: "複数関数サポート"
      status: "pass"
      notes: "expressionParser で主要数学関数サポート"
    FR-007:
      name: "微分（導関数）の計算と表示"
      status: "pass"
      notes: "derivativeCalculator: math.derivative() + 数値フォールバック (中心差分法 h=0.0001)"
    FR-008:
      name: "導関数のグラフ重畳表示"
      status: "pass"
      notes: "赤色で重畳描画。controls.js でトグル"
    FR-009:
      name: "カーソル追従ツールチップ (x, f(x), f'(x))"
      status: "pass"
      notes: "x, f(x), f'(x) 全表示。デスクトップ: カーソル追従、モバイル: 画面下部固定"
    FR-010:
      name: "接線表示"
      status: "pass"
      notes: "tangent toggle + x 座標数値入力。viewport 内 range 制限"
    FR-011:
      name: "レスポンシブデザイン"
      status: "pass"
      notes: "375px～1440px+ 対応。7 段階ブレークポイント。タッチターゲット 44px"
    FR-012:
      name: "エラーハンドリング（不正入力）"
      status: "pass"
      notes: "3 種分類 (syntax/domain/overflow) + 日本語メッセージ + aria 属性"
    FR-013:
      name: "プリセット関数ボタン"
      status: "pass"
      notes: "7 関数ボタン動的生成 (presetButtons.js)"
  passed: 13
  partial: 0
  failed: 0
  bugged: 0
  score: 98
  notes: |
    13/13 FR PASS。前回 (8 pass + 1 partial + 4 fail) から全要件充足に改善。
    接線の UX がやや簡素（数値入力のみ、ドラッグ指定なし）のため 100 ではなく 98。

# ============================================================
# 4. UX / Visual Quality - 15%
# ============================================================
ux:
  visual_design:
    score: 4
    notes: "CSS カスタムプロパティによるデザインシステム。整ったカラーパレット"
  responsive:
    score: 5
    notes: "375px～1440px+ の 7 段階対応。(hover: none) and (pointer: coarse) でタッチ最適化"
  usability:
    score: 4
    notes: "全機能が動作。プリセットボタン、トグル操作が直感的"
  error_feedback:
    score: 4
    notes: "3 種分類エラー + 日本語メッセージ。科学表記法対応"
  accessibility:
    score: 4
    notes: "aria-invalid, role='alert' 使用。タッチターゲット 44px 確保"
  average: 4.2
  score: 82
  notes: |
    前回 (3.2/64) から大幅改善。モバイルツールチップ (画面下部固定 + 3 秒自動非表示)、
    pinch zoom/pan 等のタッチ対応が包括的。

# ============================================================
# 5. Constitution Compliance (憲章準拠) - 10%
# ============================================================
constitution:
  principles:
    III_review_driven_quality:
      compliant: false
      notes: "planreview は機能したが post-implement レビュー 3 件が ISSUE-4 で実質未実行"
    V_incremental_delivery:
      compliant: true
      notes: "8 フェーズ段階的デリバリーを遵守"
    VIII_verification_gates:
      compliant: true
      notes: "tasks.md のタスク完了マーカーが実装と一致"
    X_documentation_as_code:
      compliant: true
      notes: "spec.md, plan.md, tasks.md を適切に生成・管理"
  compliant_count: 3
  score: 75
  notes: |
    段階的デリバリー・検証ゲート・ドキュメント管理は遵守。
    レビュー品質駆動は ISSUE-4 により部分的にしか機能していない。
    前回 (2/4, 50) から改善 (3/4, 75)。

# ============================================================
# 6. Efficiency (効率) - 10%
# ============================================================
efficiency:
  wall_clock_seconds: 3780
  session_count: 1
  output_lines: 1798
  output_bytes: 62000
  lines_per_second: 0.48
  files_created: 11
  score: 80
  notes: |
    63 分で 1798 行生成。前回 (180 分, 779 行) の 1/3 の時間で 2.3 倍の出力。
    implement 48 分 (8 フェーズ x 平均 6 分)。simple バリアント効果で効率大幅改善。

# ============================================================
# 総合スコア
# ============================================================
# score = process(15%) + code_quality(25%) + completeness(25%)
#       + ux(15%) + constitution(10%) + efficiency(10%)
# 計算: 85*0.15 + 85*0.25 + 98*0.25 + 82*0.15 + 75*0.10 + 80*0.10 = 86.0
scoring:
  weights:
    process: 0.15
    code_quality: 0.25
    completeness: 0.25
    ux: 0.15
    constitution: 0.10
    efficiency: 0.10
  component_scores:
    process: 85
    code_quality: 85
    completeness: 98
    ux: 82
    constitution: 75
    efficiency: 80
  total: 86
  grade: "B+"
  previous:
    total: 57
    grade: "D"
    improvement: "+29"

# ============================================================
# サマリ
# ============================================================
summary:
  strengths:
    - "全 13/13 FR PASS。前回の 8 pass + 1 partial + 4 fail から完全充足に改善"
    - "全 11 モジュール生成 (1798 行)。前回 (7 モジュール, 779 行) から +130% 出力増加"
    - "モジュラー設計 (core/ui/utils 責務分離) が適切"
    - "derivativeCalculator: シンボリック微分 + 数値フォールバック。堅牢な実装"
    - "包括的なモバイル対応 (touch events, pinch zoom, 44px targets, media queries)"
    - "63 分で完了。前回の 1/3 の時間で 2.3 倍の出力"
  weaknesses:
    - "git commit が全く作成されていない (ISSUE-1: pipeline-runner.sh の || true)"
    - "post-implement レビュー 3 件が実質未実行 (ISSUE-4: review-runner.sh の local バグ)"
    - "planreview 14 件の指摘が実装に反映されていない (ISSUE-2)"
    - "CSS に冗長な media query 重複"
    - "debounce の cancel メソッド欠落"
  critical_issues:
    - "ISSUE-1: pipeline-runner.sh:524 の || true で git commit エラー消音。修正済み"
    - "ISSUE-4: review-runner.sh:149 の local outside function + pipeline-runner.sh の exit 1 無視。修正済み"
  recommendations:
    - "修正後に短いテストランで ISSUE-1/4 の解消を確認"
    - "レビューフィードバックループを実装し、CONDITIONAL 指摘を tasks.md に自動反映"
    - "tasksreview のペルソナ dispatch 失敗原因を調査 (ISSUE-3)"

# ============================================================
# システムバグ (前回からの引継ぎ + 今回発見)
# ============================================================
system_issues:
  - id: "BUG-3"
    component: "lib/pipeline-runner.sh"
    description: "dispatch_implement_phases()がバリアント解決をバイパス"
    impact: "GLM-5 がフル版 implement.md を受信し 5/8 モジュール未生成"
    fix_status: "fixed (前回修正済み)"
  - id: "BUG-5"
    component: "lib/review-runner.sh"
    description: "TARGET_FILE がディレクトリの場合にコンテキスト未渡し"
    impact: "post-implement レビューでコード未参照"
    fix_status: "fixed (前回修正済み)"
  - id: "ISSUE-1"
    component: "lib/pipeline-runner.sh:522-524"
    description: "git commit の || true でエラー消音。全成果物が untracked のまま"
    impact: "フェーズ成果物の git 保護が無効化。diff ベースのレビューコンテキスト生成不可"
    fix_status: "fixed (本レビューで修正)"
  - id: "ISSUE-4"
    component: "lib/review-runner.sh:149-150"
    description: "local を関数外で使用。set -e で即死。ディレクトリターゲットレビューのみ影響"
    impact: "architecturereview/qualityreview/phasereview が実質未実行"
    fix_status: "fixed (本レビューで修正)"
