# Data Model: 関数ビジュアライザー（微分機能付き）

**Date**: 2026-02-17
**Feature**: 002-fr001-fr002-fr003-fr004

## Entities

### 1. FunctionExpression

**Purpose**: Represents a mathematical function entered by the user

```typescript
interface FunctionExpression {
  id: string;
  raw: string;           // User input: "x^2", "sin(x)"
  normalized: string;    // math.js format: "x ^ 2", "sin(x)"
  isValid: boolean;
  error?: string;        // Parse error message if invalid
}
```

**Validation Rules**:
- `raw` must not be empty (empty → default state)
- `normalized` is parsed by math.js; SyntaxError → `isValid: false`
- Supported operators: +, -, *, /, ^, ()
- Supported functions: sin, cos, tan, log, exp, sqrt, abs

**State Transitions**:
```
[Empty] → [Valid] → [Invalid] → [Valid] → ...
          ↓
       [Cleared]
```

### 2. Derivative

**Purpose**: Calculated derivative of a function expression

```typescript
interface Derivative {
  sourceId: string;      // Reference to FunctionExpression.id
  expression: string;    // Symbolic result: "2 * x"
  isValid: boolean;
  error?: string;        // Calculation error if any
}
```

**Relationships**:
- Many-to-One with FunctionExpression (multiple calculations possible)
- Generated by math.derivative()

**Calculation Rules**:
- Only calculated when source expression is valid
- Caching: memoize by expression string

### 3. GraphState

**Purpose**: Visual configuration and interaction state

```typescript
interface GraphState {
  domain: {
    x: [number, number];  // [xMin, xMax]
    y: [number, number];  // [yMin, yMax]
  };
  showGrid: boolean;
  showAxisLabels: boolean;
  showDerivative: boolean;
  tangentLine: {
    enabled: boolean;
    x: number;            // x-coordinate of tangent point
  } | null;
  zoomLevel: number;
}
```

**Default Values**:
```typescript
const defaultGraphState: GraphState = {
  domain: { x: [-10, 10], y: [-10, 10] },
  showGrid: true,
  showAxisLabels: true,
  showDerivative: false,
  tangentLine: null,
  zoomLevel: 1,
};
```

### 4. TooltipData

**Purpose**: Real-time cursor position and function values

```typescript
interface TooltipData {
  x: number;           // Cursor x-coordinate
  fx: number;          // f(x) value
  fpx: number | null;  // f'(x) value (null if no derivative)
  visible: boolean;
}
```

**Update Frequency**: 30fps minimum (requestAnimationFrame)

### 5. PresetFunction

**Purpose**: Predefined function shortcuts

```typescript
interface PresetFunction {
  id: string;
  label: string;       // Button text: "sin(x)"
  expression: string;  // Function: "sin(x)"
  category: 'trig' | 'poly' | 'exp' | 'other';
}

const presets: PresetFunction[] = [
  { id: 'sin', label: 'sin(x)', expression: 'sin(x)', category: 'trig' },
  { id: 'cos', label: 'cos(x)', expression: 'cos(x)', category: 'trig' },
  { id: 'tan', label: 'tan(x)', expression: 'tan(x)', category: 'trig' },
  { id: 'x2', label: 'x²', expression: 'x^2', category: 'poly' },
  { id: 'x3', label: 'x³', expression: 'x^3', category: 'poly' },
  { id: 'log', label: 'log(x)', expression: 'log(x)', category: 'exp' },
  { id: 'exp', label: 'eˣ', expression: 'exp(x)', category: 'exp' },
  { id: 'sqrt', label: '√x', expression: 'sqrt(x)', category: 'other' },
  { id: 'abs', label: '|x|', expression: 'abs(x)', category: 'other' },
];
```

## Entity Relationships

```
┌─────────────────────┐
│ FunctionExpression  │
│ ─────────────────── │
│ id: string          │
│ raw: string         │
│ normalized: string  │
│ isValid: boolean    │
└──────────┬──────────┘
           │ 1
           │
           │ has
           │
           ▼ 1
┌─────────────────────┐
│    Derivative       │
│ ─────────────────── │
│ sourceId: string    │
│ expression: string  │
│ isValid: boolean    │
└─────────────────────┘

┌─────────────────────┐
│    GraphState       │
│ ─────────────────── │
│ domain: Domain      │
│ showDerivative: bool│
│ tangentLine: Tangent│
└─────────────────────┘

┌─────────────────────┐
│    TooltipData      │
│ ─────────────────── │
│ x: number           │
│ fx: number          │
│ fpx: number | null  │
└─────────────────────┘

┌─────────────────────┐
│  PresetFunction     │
│ ─────────────────── │
│ id: string          │
│ label: string       │
│ expression: string  │
└─────────────────────┘
```

## State Management

**Approach**: Simple reactive state using event-based updates

```typescript
// NOTE: MVP (P1) supports single function via expressions[0]; P2 adds multi-function support
class AppState {
  private expressions: FunctionExpression[] = [];
  private derivative: Derivative | null = null;
  private graphState: GraphState = defaultGraphState;
  private tooltipData: TooltipData | null = null;

  // Event emitters for reactive updates
  onExpressionChange: EventEmitter<FunctionExpression>;
  onDerivativeChange: EventEmitter<Derivative>;
  onGraphStateChange: EventEmitter<GraphState>;
  onTooltipChange: EventEmitter<TooltipData>;
}
```

## Validation Rules Summary

| Entity | Field | Rule |
|--------|-------|------|
| FunctionExpression | raw | Non-empty, valid math.js syntax |
| FunctionExpression | normalized | Valid math.js parse result |
| Derivative | expression | Result of math.derivative() |
| GraphState | domain.x | x[0] < x[1] |
| GraphState | domain.y | y[0] < y[1] |
| TooltipData | x | Within domain.x range |

## Error States

| Error Type | Handling | User Message |
|------------|----------|--------------|
| Parse Error | Catch SyntaxError | "数式が正しくありません: {error}" |
| Division by Zero | Show gap in graph | No message (visual gap) |
| Invalid Function | Set isValid: false | "この関数はサポートされていません" |
| Empty Input | Default state | No message (empty graph) |
