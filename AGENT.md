# PoorDevSkills エージェントワークフロー

**最終更新**: 2026-02-23
**バージョン**: 2.0.0

このドキュメントは、poor-dev コマンド群による標準開発フローを定義します。すべてのエージェントはこのワークフローに従ってください。

---

## 目次

1. [概要](#概要)
2. [コマンドリファレンス](#コマンドリファレンス)
3. [標準フロー](#標準フロー)
4. [品質ゲート](#品質ゲート)
5. [レビュー戦略](#レビュー戦略)
6. [憲法コンプライアンス](#憲法コンプライアンス)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

このワークフローは以下の原則に基づいて設計されています：

- **開発コマンド**: 仕様化・計画・タスク分解の構造化されたアプローチ
- **レビューコマンド**: 多角的レビューによる品質保証
- **Bash Dispatch**: Opus 仲介による Worker ディスパッチ（`glm -p` 経由）
- **品質ゲート**: 自動化された検証チェック
- **段階的配信**: MVP優先の漸進的開発

### コア原則

1. **仕様主導**: ユーザー価値から始める
2. **計画レビュー**: 実装前に品質を担保
3. **検証ゲート**: 自動化された品質チェック
4. **自動レビューループ**: Reviewer → Fixer → Reviewer の収束ループ
5. **段階的配信**: MVPを優先する

---

## コマンドリファレンス

### 開発系コマンド

| コマンド | 用途 | 入力 | 出力 |
|----------|------|------|------|
| `/poor-dev` | パイプラインオーケストレータ | 機能説明 | 全ステップ自動実行 |
| `/poor-dev.discovery` | 探索フロー開始 | アイデア/既存コード | discovery-memo.md |
| `/poor-dev.rebuildcheck` | リビルド判定 | なし | 分析レポート + CONTINUE/REBUILD |
| `/poor-dev.harvest` | 知見収穫 + 再構築準備 | なし | learnings.md, constitution.md, spec.md |
| `/poor-dev.specify` | 仕様作成 | 機能説明 | spec.md, チェックリスト |
| `/poor-dev.plan` | 技術計画 | なし | plan.md, research.md, data-model.md, contracts/, quickstart.md |
| `/poor-dev.tasks` | タスク分解 | なし | tasks.md |
| `/poor-dev.implement` | 実装実行 | なし | 実装コード |
| `/poor-dev.testdesign` | テスト計画作成 | なし | test-plan.md |
| `/poor-dev.clarify` | 仕様明確化 | なし | 更新されたspec.md |
| `/poor-dev.analyze` | 整合性分析 | なし | 分析レポート |
| `/poor-dev.checklist` | チェックリスト作成 | ドメイン | ドメインチェックリスト |

### Review系コマンド（統合オーケストレータ）

| コマンド | 用途 | ペルソナ（統合エージェント内） | 自動ループ |
|----------|------|-------------------------------|-----------|
| `/poor-dev.planreview` | 計画レビュー | PM, RISK, VAL, CRIT | Yes |
| `/poor-dev.tasksreview` | タスク分解レビュー | TECHLEAD, SENIOR, DEVOPS, JUNIOR | Yes |
| `/poor-dev.architecturereview` | 設計レビュー | ARCH, SEC, PERF, SRE | Yes |
| `/poor-dev.qualityreview` | 品質レビュー | QA, TESTDESIGN, CODE, SEC | Yes |
| `/poor-dev.phasereview` | フェーズ完了レビュー | QA, REGRESSION, DOCS, UX | Yes |

### ユーティリティ系コマンド

| コマンド | 用途 |
|----------|------|
| `/poor-dev.report` | プロジェクトレポート生成 |
| `/poor-dev.constitution` | 憲法の作成・更新 |
| `/poor-dev.bugfix` | バグ調査・修正 |
| `/poor-dev.investigate` | 問題調査 |
| `/poor-dev.ask` | コードベースに関する質問応答 |

---

## 標準フロー

### 探索フロー図（スクラップ＆ビルド）

```
┌─────────────────────────────────────────────────────────────┐
│ 0. 受付                                                      │
│    /poor-dev → "discovery" 分類                             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 1. 探索開始                                                  │
│    /poor-dev.discovery                                      │
│    → 既存コード検出で Mode A/B 自動分岐                     │
│    → discovery-memo.md 生成                                 │
│    → CLAUDE.md にリビルドトリガー設定                       │
│    ├─ Mode A: ゼロから → 自由にプロトタイプ                 │
│    └─ Mode B: 既存コード → 継続 or rebuildcheck             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. プロトタイプ                                              │
│    自由にバイブコーディング                                   │
│    → CLAUDE.md のトリガーが自動提案                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. リビルド判定                                              │
│    /poor-dev.rebuildcheck                                   │
│    → 4 シグナル分析（局所性/振り子/肥大化/ホットスポット）  │
│    → CONTINUE or REBUILD                                    │
└─────────────────────────────────────────────────────────────┘
                          ↓ (REBUILD)
┌─────────────────────────────────────────────────────────────┐
│ 4. 知見収穫                                                  │
│    /poor-dev.harvest                                        │
│    → learnings.md（動作機能・困難・本当の要件）             │
│    → constitution.md（ペインポイントから原則を導出）         │
│    → spec.md（検証済み機能のみ P1）                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 標準フローへ合流                                          │
│    /poor-dev.plan → tasks → implement → review              │
└─────────────────────────────────────────────────────────────┘
```

### 機能開発フロー図（Bash Dispatch パイプライン）

```
┌─────────────────────────────────────────────────────────────┐
│ 0. Phase 0: 壁打ち                                           │
│    /poor-dev → Plan モードで Opus がユーザーと壁打ち         │
│    → ユーザー承認後に Core Loop 開始                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 1. specify → 2. plan → 3. planreview                        │
│    各ステップは Worker を `glm -p` で Bash Dispatch          │
│    → spec.md → plan.md → GO/CONDITIONAL/NO-GO               │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. tasks → 5. tasksreview                                    │
│    → tasks.md → 依存関係・並列化の確認                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. implement                                                 │
│    → Worker による並列実装（フェーズ分割ディスパッチ）       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 7. testdesign                                                │
│    → test-plan.md 生成                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 8-10. architecturereview → qualityreview → phasereview      │
│    レビューループ: Opus 仲介                                 │
│    reviewer → Opus → fixer → Opus（glm -p 経由）           │
└─────────────────────────────────────────────────────────────┘
```

### クイックリファレンス

| フェーズ | コマンド | 確認事項 |
|----------|----------|----------|
| 仕様 | `/poor-dev.specify` | ユーザー価値、明確な要件 |
| 計画 | `/poor-dev.plan` → `/poor-dev.planreview` | 技術選択、アーキテクチャ |
| タスク | `/poor-dev.tasks` → `/poor-dev.tasksreview` | 依存関係、並列化 |
| 実装 | `/poor-dev.implement` | Worker による並列実装 |
| テスト設計 | `/poor-dev.testdesign` | テスト計画 |
| レビュー | 3段レビュー (arch/quality/phase) | 品質・セキュリティ・DoD |

---

## 品質ゲート

### 自動実行されるゲート

品質ゲートは各ステップ完了時に自動チェック:

#### 1. 型チェック

言語ごとの標準コマンド:

```bash
# TypeScript/JavaScript
tsc --noEmit

# Python
mypy . || ruff check

# Rust
cargo check

# Go
go vet ./...
```

#### 2. リンティング

```bash
# TypeScript/JavaScript
eslint . --max-warnings 0

# Python
ruff lint || flake8 . --max-line-length=88

# Rust
cargo clippy -- -D warnings

# Go
golangci-lint run
```

#### 3. フォーマットチェック

```bash
# TypeScript/JavaScript
prettier --check "**/*.{ts,tsx,js,jsx,json,md}"

# Python
black --check .

# Rust
cargo fmt --check

# Go
gofmt -l .
```

#### 4. テスト

```bash
# TypeScript/JavaScript
npm test -- --coverage

# Python
pytest --cov

# Rust
cargo test

# Go
go test ./... -cover
```

### ゲート失敗時の処理

1. **CRITICAL**: ビルドエラー、型エラー
   - 即座に修正が必要
   - 他のゲートをスキップ

2. **HIGH**: リンティング警告、重要なテスト失敗
   - 修正を推奨
   - 理由を文書化すればスキップ可能

3. **MEDIUM**: 軽微なリンティング警告、カバレッジ未達成
   - 改善を推奨
   - 次のスプリントで対応

4. **LOW**: スタイルの問題、ドキュメントの不足
   - タスク完了許可
   - 後で改善

### カバレッジ要件

- **重要パス**: 100% カバレッジ（TDD必須）
- **通常パス**: 80% 以上のカバレッジ
- **全体**: 70% 以上のカバレッジ

---

## レビュー戦略

### アーキテクチャ: Opus 仲介レビューループ

レビューシステムは以下のアーキテクチャで動作:

1. **統合ペルソナ**: 各レビュータイプは統合エージェント定義（`agents/claude/`）
2. **Opus 仲介**: Orchestrator (Opus) がレビュー結果を集約し Fixer に指示
3. **自動修正ループ**: C/H issue 0件になるまで Review → Fix → Review を繰り返す
4. **Bash Dispatch**: Worker は `glm -p` 経由でディスパッチ

```
STEP 1: Reviewer sub-agent (READ-ONLY, glm -p dispatch)
   ↓
STEP 2: Opus がイシューを集約・dedup・収束判定
   ↓
STEP 3: C/H > 0 → Fixer sub-agent (glm -p dispatch) → back to STEP 1
         C/H = 0 → DONE + next step
```

**安全策**:
- レビューサブエージェント: read-only（Write/Edit/Bash 禁止）
- 修正サブエージェント: write-enabled（`review-fixer`）
- maxReviewIterations 超過で安全弁（ユーザー確認）

### エージェント間通信: YAML フォーマット

トークン効率のため、エージェント間通信は全て英語 YAML:

```yaml
verdict: CONDITIONAL
issues:
  - severity: H
    description: success metrics not quantitative
    location: spec.md
  - severity: M
    description: P2 priority rationale unclear
    location: plan.md
```

### レビューの判定

- **GO**: 重大な問題なし、実装を進めてよい
- **CONDITIONAL**: 軽微な問題あり、修正後に進めてよい
- **NO-GO**: 重大な問題あり、修正が必要

### フィードバックの優先順位

- **C (Critical)**: 実装を妨げる重大な問題
- **H (High)**: 品質に影響する重要な問題
- **M (Medium)**: 改善が必要だが致命的ではない
- **L (Low)**: 軽微な改善提案

---

## 憲法コンプライアンス

### 憲法第VIII章：検証ゲート

すべてのサブタスク完了は終了前に検証ゲートを通過しなければなりません。

**ゲート**:
1. 型チェック
2. テスト
3. リンティング
4. レビューループ

**検証をスキップする場合**:
- 明確な正当化が必要
- 理由を文書化
- チームの承認

### 憲法第III章：レビュー主導品質

すべてのコード変更はマージ前にレビューループを通過しなければなりません。

**規則**:
- すべてのステップ完了にはレビューループが必要
- C/H issue が 0 になるまでループ継続
- maxReviewIterations 超過時はユーザー確認

### 憲法第IV章：重要パスのテストファースト

重要なコードパスはTDDを使用しなければなりません。

**重要パスの例**:
- 認証
- 認可
- 支払い処理
- データ整合性

**TDDサイクル**:
1. 失敗するテストを書く
2. テストが失敗することを確認する
3. 実装コードを書く
4. テストをパスする
5. リファクタリング

---

## トラブルシューティング

### 品質ゲートの失敗

**問題**: 品質ゲートが失敗する

**解決策**:
1. 失敗したゲートを確認
2. 問題を修正
3. ゲートを再実行
4. 全てのゲートがパスするまで繰り返す

### レビューがNO-GO

**問題**: レビューでNO-GO判定

**解決策**:
Opus 仲介の自動ループが修正→再レビューを自動実行します。
手動介入が必要な場合は maxReviewIterations 超過時にユーザー確認が入ります。

### パイプラインの中断

**問題**: パイプライン実行中に中断が発生

**解決策**:
1. `pipeline-state.json` を確認して現在のステップを特定
2. `/poor-dev` を再実行すると、中断したステップから再開
3. compaction 後も `pipeline-state.json` から回復可能

### タスクが不完全

**問題**: `/poor-dev.tasks` で生成されたタスクが不完全

**解決策**:
1. spec.mdとplan.mdを確認
2. 足りないタスクを追加
3. tasks.mdを更新
4. `/poor-dev.tasksreview` で確認

---

## ベストプラクティス

### 仕様化

- ユーザーの言葉で書く
- 実装詳細を避ける
- 明確な受け入れ基準を定義する
- 優先順位（P1, P2, P3）を付ける

### 計画

- 技術選択の理由を文書化する
- 研究と決定を記録する
- アーキテクチャを明確にする
- リスクを特定する

### タスク分解

- ユーザーストーリーごとに整理する
- タスクを具体的にする
- 並列化の機会を特定する
- 検証ゲートを含める

### 実装

- Worker による並列実装を活用する
- 進捗を報告する
- エラーを即座に報告する

### レビュー

- 早期にレビューを実行する
- 全てのペルソナを活用する
- 建設的なフィードバックを提供する
- 優先順位を明確にする

### 品質保証

- 全ての品質ゲートを通過する
- レビューループを完走する
- テスト網羅性を確保する
- Definition of Doneを確認する

---

## 用語集

| 用語 | 定義 |
|------|------|
| poor-dev コマンド | 仕様化・計画・タスク分解のフレームワーク |
| Bash Dispatch | `glm -p` 経由で Worker をディスパッチする実行方式 |
| レビューループ | Reviewer → Opus → Fixer → Opus の自動収束ループ |
| 品質ゲート | 型チェック、リンティング、テスト等の自動検証 |
| ペルソナ | 特定の観点からレビューを行う役割（統合エージェント内） |
| Definition of Done | タスク完了の基準 |
| TDD | テスト駆動開発 |

---

## リソース

- [憲法](constitution.md)
- [レビューオーケストレータ](commands/poor-dev.*review.md)
- [ペルソナエージェント](agents/claude/)
- [ベンチマーク](docs/benchmarks.md)

---

**最終更新**: 2026-02-23
**次回見直し**: 2026-03-23
